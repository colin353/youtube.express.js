// Generated by CoffeeScript 1.6.2
var MediaInterfaceElement, VolumeController, allLoaded, isNoLongerPlaying, isPlaying, onAllReady, playerID, playing_video, renderUpcomingIfAvailable, size, socket, socket_url, video_media, video_not_yet_started, volumeDetector;

socket_url = '/';

size = {
  x: 436,
  y: 356
};

playerID = 'ytplayer';

video_media = [];

playing_video = null;

socket = null;

allLoaded = false;

document.connectToServer = function() {
  socket = io.connect(socket_url);
  socket.on('play', function(data) {
    console.log("Play detected", data);
    document.didPlayVideo();
    return isPlaying();
  });
  socket.on('pause', function(data) {
    console.log("Pause detected", data);
    document.didPauseVideo();
    return isNoLongerPlaying();
  });
  socket.on('volume', function(vol) {
    console.log("Volume change detected ", vol);
    return document.volume.setVolume(vol);
  });
  socket.on('skipped', function(video_code) {
    console.log("Skip initiated on video ", video_code);
    if (playing_video.video_code === video_code) {
      document.didLoadVideo(video_media[0].video.video_code);
      return playing_video = video_media[0].video;
    } else {
      return console.log('Skipped video actually not playing, so we are good');
    }
  });
  socket.on('upcoming', function(videos) {
    var v, _i, _len;

    console.log('Got a new video list.');
    if (videos.length > 0 && video_not_yet_started()) {
      document.didSkipVideo(videos[0].video_code);
    }
    if ((playing_video == null) && videos.length > 0) {
      playing_video = videos[0];
    }
    video_media = [];
    $('.media-list').html(' ');
    for (_i = 0, _len = videos.length; _i < _len; _i++) {
      v = videos[_i];
      if ((playing_video == null) || v.video_code !== playing_video.video_code) {
        video_media.push(new MediaInterfaceElement(v));
      } else {
        playing_video = v;
      }
    }
    return setTimeout(renderUpcomingIfAvailable, 200);
  });
  return document.join();
};

document.join = function(party) {
  if (party == null) {
    party = 'default';
  }
  return socket.emit('join', 'default');
};

document.play = function() {
  return socket.emit('play', {});
};

document.didPlayVideo = function() {
  return console.log('Playing.');
};

document.pause = function() {
  return socket.emit('pause', {});
};

document.didPauseVideo = function() {
  return console.log('Paused.');
};

document.didLoadVideo = function() {
  return console.log('Video loaded.');
};

document.setVolume = function(vol) {
  return socket.emit('volume', vol);
};

document.didSetVolume = function(vol) {
  return console.log('Volume set.');
};

document.update = function() {
  return socket.emit('update', {});
};

document.skip = function() {
  var vid;

  vid = playing_video;
  return socket.emit('skip', vid);
};

video_not_yet_started = function() {
  return true;
};

document.didSkipVideo = function() {
  return console.log('Skipped.');
};

document.addVideo = function(video_code) {
  return socket.emit('add', {
    video_code: video_code
  });
};

document.didUpdateUpcoming = function() {
  return $('ul.media-list .media').click(function() {
    $(this).css('position', 'relative').css('z-index', 100);
    return $('.bigblock').css('opacity', '0.5').show();
  });
};

renderUpcomingIfAvailable = function() {
  var all_loaded, v, _i, _j, _len, _len1;

  all_loaded = true;
  for (_i = 0, _len = video_media.length; _i < _len; _i++) {
    v = video_media[_i];
    if (v.loaded === false) {
      all_loaded = false;
      break;
    }
  }
  $('.media-list').html(' ');
  if (all_loaded) {
    for (_j = 0, _len1 = video_media.length; _j < _len1; _j++) {
      v = video_media[_j];
      v.insert();
    }
  }
  document.didUpdateUpcoming();
  if (!allLoaded) {
    return setTimeout(onAllReady(), 300);
  } else {
    return setTimeout(renderUpcomingIfAvailable, 200);
  }
};

MediaInterfaceElement = (function() {
  function MediaInterfaceElement(video) {
    var me;

    this.video = video;
    me = this;
    me.loaded = false;
    $.get("https://gdata.youtube.com/feeds/api/videos/" + this.video.video_code + "?v=2&alt=json", function(r) {
      me.description = r.valueOf('media$group').entry.media$group.media$description.$t.substring(0, 140);
      me.title = r.valueOf('media$group').entry.title.$t.substring(0, 64);
      return me.loaded = true;
    });
  }

  MediaInterfaceElement.prototype.render = function() {
    var html;

    html = '<li class="media well"><a class="pull-left" href="#">';
    html += "<img class='media-object' style='width:100px' src='http://img.youtube.com/vi/" + this.video.video_code + "/hqdefault.jpg'></a>";
    html += "<div class='media-body'><h4 class='media-heading'>" + this.title + "</h4><div class='media'>";
    html += "" + this.description + "</div></div></li>";
    return html;
  };

  MediaInterfaceElement.prototype.insert = function() {
    return $('.media-list').append(this.render());
  };

  return MediaInterfaceElement;

})();

VolumeController = (function() {
  function VolumeController() {
    this.percent = 80;
    this.setVolume(this.percent);
  }

  VolumeController.prototype.setVolume = function(percent) {
    this.percent = percent;
    $('.volume-control').css('width', "" + this.percent + "%");
    return document.didSetVolume(this.percent);
  };

  return VolumeController;

})();

volumeDetector = function(e) {
  var x, x_o, y, y_o;

  x_o = this.offsetLeft - this.scrollLeft;
  y_o = this.offsetTop - this.scrollTop;
  x = e.pageX - x_o;
  y = e.pageY - y_o;
  return document.setVolume(x * 100 / $('.volume-container').width());
};

isPlaying = function() {
  $('.play-control').hide();
  return $('.pause-control').show();
};

isNoLongerPlaying = function() {
  $('.play-control').show();
  return $('.pause-control').hide();
};

onAllReady = function() {
  $('.bigblock').fadeOut('slow');
  document.volume = new VolumeController();
  allLoaded = true;
  $('.volume-container').click(volumeDetector);
  $('.pause-control').click(document.pause);
  $('.skip-control').click(document.skip);
  return $('.play-control').click(document.play);
};

document.getURLParameter = function getURLParameter(url,name) {
    return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(url)||[,""])[1].replace(/\+/g, '%20'))||null;
};

$(function() {
  $('.add-button').click(function() {
    return $('.add-modal').modal('show');
  });
  return $('.modal-save').click(function() {
    var url, video_code;

    url = $('.add-value').val();
    $('.add-value').val(' ');
    video_code = document.getURLParameter(url, 'v');
    return document.addVideo(video_code);
  });
});
